<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="js/Three.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/Stats.js"></script>
    <script src="js/THREEx.KeyboardState.js"></script>
    <script src="js/THREEx.FullScreen.js"></script>
    <script src="js/THREEx.WindowResize.js"></script>
    <script>
      $(function() {
        $('#bone').bind('click', function() {
          $('#allct').hide();
          $('#allbone').show();
          $('#initial').show();
          $('#options').hide();
          $('#render').html('');
        });

        $('#ct').bind('click', function() {
          $('#render').html('');
          $('#allbone').hide();
          $('#allct').show();
          $('#options').hide();
        });

        $('#ctsubmit').bind('click', function() {
          $('#render').html('');
          $('#options').show();
          window.bid = 'bone';
          animateBone('api/id_to_render/' + window.bid);
          return false;
        });


        function animateBone(modelPath) {
          init(modelPath);
          animate(new Date().getTime());
        }

        /* 	Three.js  */

        // MAIN
        if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
        // standard global variables
        var container, scene, camera, renderer, controls, stats;

        // custom global variables
        var android;

        var WIDTH = 800, HEIGHT = 600;

        // FUNCTIONS 		
        function init(modelPath) 
        {
          var VIEW_ANGLE = 45, ASPECT = WIDTH / HEIGHT, NEAR = 0.1, FAR = 20000; 

          container = $('#render');

          renderer = new THREE.WebGLRenderer( {antialias: true} );
          camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);

          scene = new THREE.Scene();
          scene.add(camera);

          // camera.position.set(0,150,400);
          camera.position.z = 300;

          renderer.setSize(WIDTH, HEIGHT);
          container.html(renderer.domElement);

          var light = new THREE.PointLight(0xffffff);
          light.position.set(-100,200,100);
          scene.add(light);

          var jsonLoader = new THREE.JSONLoader();
          jsonLoader.load( modelPath, addModelToScene );

          var ambientLight = new THREE.AmbientLight(0x111111);
          scene.add(ambientLight);
        }

        function addModelToScene( geometry ) 
        {
          var material = new THREE.MeshFaceMaterial();
          android = new THREE.Mesh( geometry, material );
          THREE.GeometryUtils.center(geometry);

          delta = new THREE.Vector3().sub(android.geometry.boundingBox.max, android.geometry.boundingBox.min);
          mu = 0.01;

          lambda = mu * delta.length();
          console.log(lambda);
          android.scale.set(lambda, lambda, lambda);


          scene.add( android );
        }

        function animate(t) {
          camera.position.x = Math.sin(t/1000)*300;
          camera.position.y = 150;
          camera.position.z = Math.cos(t/1000)*300;
          camera.lookAt(scene.position)
          renderer.render(scene, camera);

          requestAnimationFrame( animate, renderer.domElement );
          render();		
        }

        function render() 
        {
          renderer.render( scene, camera );
        }


        $('#obj').bind('click', function() {
          window.open('api/id_to_obj/' + window.bid + '.obj', '_blank');
        });

        $('#gcode').bind('click', function() {
          window.open('api/id_to_gcode/' + window.bid + '.gcode', '_blank');
        });

        $('#allbone').hide();
        $('#allct').hide();
        $('#options').hide();

        function bone_select() {
          $('#options').show();
          window.bid = $('#bones option:selected').val();
          animateBone('api/id_to_render/' + window.bid);
        }

        $.ajax({
          url: "api/list_of_bones",
          dataType: 'json'
        }).done(function(data) {
          $.each(data, function(v, k) {
            $('#bones').append('<option value="' + k['bid'] + '">' + k['name'] + '</option>');
          });
          $('#bones').bind('change', bone_select);
        });
      });
    </script>
  </head>
  <body>
    <div id="choose">
      <a id="ct">CT</a> or <a id="bone">bone</a>?
    </div>
    <div id="allbone">
      <div id="initial">
        Choose a bone
        <form>
          <select id="bones">
            <option value=""></option>
          </select>
        </form>
      </div>
    </div>
    <div id="allct">
      <form>
        <input type="file">
        <input id="ctsubmit" type="submit" value="Submit">
      </form>
    </div>
    <div id="options">
      <a id="obj">Obj (for editing)</a> or <a id="gcode">gcode (for printing)</a>?
    </div>
    <div id="render">
    </div>
  </body>
</html>
